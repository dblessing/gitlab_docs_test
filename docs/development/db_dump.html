<h1 id="importing-a-database-dump-into-a-staging-enviroment">Importing a database dump into a staging enviroment</h1>

<p>Sometimes it is useful to import the database from a production environment
into a staging environment for testing. The procedure below assumes you have
SSH+sudo access to both the production environment and the staging VM.</p>

<p><strong>Destroy your staging VM</strong> when you are done with it. It is important to avoid
data leaks.</p>

<p>On the staging VM, add the following line to <code class="prettyprint">/etc/gitlab/gitlab.rb</code> to speed up
large database imports.</p>
<pre class="highlight plaintext"><code># On STAGING
echo "postgresql['checkpoint_segments'] = 64" | sudo tee -a /etc/gitlab/gitlab.rb
sudo touch /etc/gitlab/skip-auto-migrations
sudo gitlab-ctl reconfigure
sudo gitlab-ctl stop unicorn
sudo gitlab-ctl stop sidekiq
</code></pre>

<p>Next, we let the production environment stream a compressed SQL dump to our
local machine via SSH, and redirect this stream to a psql client on the staging
VM.</p>
<pre class="highlight plaintext"><code># On LOCAL MACHINE
ssh -C gitlab.example.com sudo -u gitlab-psql /opt/gitlab/embedded/bin/pg_dump -Cc gitlabhq_production |\
  ssh -C staging-vm sudo -u gitlab-psql /opt/gitlab/embedded/bin/psql -d template1
</code></pre>

<h2 id="recreating-directory-structure">Recreating directory structure</h2>

<p>If you need to re-create some directory structure on the staging server you can
use this procedure.</p>

<p>First, on the production server, create a list of directories you want to
re-create.</p>
<pre class="highlight plaintext"><code># On PRODUCTION
(umask 077; sudo find /var/opt/gitlab/git-data/repositories -maxdepth 1 -type d -print0 &gt; directories.txt)
</code></pre>

<p>Copy <code class="prettyprint">directories.txt</code> to the staging server and create the directories there.</p>
<pre class="highlight plaintext"><code># On STAGING
sudo -u git xargs -0 mkdir -p &lt; directories.txt
</code></pre>
