<h2 id="test-and-deploy-a-python-application">Test and Deploy a python application</h2>

<p>This example will guide you how to run tests in your Python application and deploy it automatically as Heroku application.</p>

<p>You can checkout the example <a href="https://gitlab.com/ayufan/python-getting-started">source</a> and check <a href="https://ci.gitlab.com/projects/4080">CI status</a>.</p>

<h3 id="configure-project">Configure project</h3>

<p>This is what the <code class="prettyprint">.gitlab-ci.yml</code> file looks like for this project:
&ldquo;<code class="prettyprint">yaml
test:
  script:
  # this configures django application to use attached postgres database that is run on</code>postgres` host
  - export DATABASE_URL=postgres://postgres:@postgres:5432/python-test-app
  - apt-get update -qy
  - apt-get install -y python-dev python-pip
  - pip install -r requirements.txt
  - python manage.py test</p>

<p>staging:
  type: deploy
  script:
  - apt-get update -qy
  - apt-get install -y ruby-dev
  - gem install dpl
  - dpl &ndash;provider=heroku &ndash;app=gitlab-ci-python-test-staging &ndash;api-key=$HEROKU_STAGING_API_KEY
  only:
  - master</p>

<p>production:
  type: deploy
  script:
  - apt-get update -qy
  - apt-get install -y ruby-dev
  - gem install dpl
  - dpl &ndash;provider=heroku &ndash;app=gitlab-ci-python-test-prod &ndash;api-key=$HEROKU_PRODUCTION_API_KEY
  only:
  - tags
&rdquo;`</p>

<p>This project has three jobs:
1. <code class="prettyprint">test</code> - used to test rails application,
2. <code class="prettyprint">staging</code> - used to automatically deploy staging environment every push to <code class="prettyprint">master</code> branch
3. <code class="prettyprint">production</code> - used to automatically deploy production environmnet for every created tag</p>

<h3 id="store-api-keys">Store API keys</h3>

<p>You&rsquo;ll need to create two variables in <code class="prettyprint">Project &gt; Variables</code>:
1. <code class="prettyprint">HEROKU_STAGING_API_KEY</code> - Heroku API key used to deploy staging app,
2. <code class="prettyprint">HEROKU_PRODUCTION_API_KEY</code> - Heroku API key used to deploy production app.</p>

<p>Find your Heroku API key in <a href="https://dashboard.heroku.com/account">Manage Account</a>.</p>

<h3 id="create-heroku-application">Create Heroku application</h3>

<p>For each of your environments, you&rsquo;ll need to create a new Heroku application.
You can do this through the <a href="https://dashboard.heroku.com/">Dashboard</a>.</p>

<h3 id="create-runner">Create runner</h3>

<p>First install <a href="https://docs.docker.com/installation/">Docker Engine</a>.
To build this project you also need to have <a href="https://about.gitlab.com/gitlab-ci/#gitlab-runner">GitLab Runner</a>. 
You can use public runners available on <code class="prettyprint">gitlab.com/ci</code>, but you can register your own:
<code class="prettyprint">
gitlab-ci-multi-runner register \
  --non-interactive \
  --url &quot;https://gitlab.com/ci/&quot; \
  --registration-token &quot;PROJECT_REGISTRATION_TOKEN&quot; \
  --description &quot;python-3.2&quot; \
  --executor &quot;docker&quot; \
  --docker-image python:3.2 \
  --docker-postgres latest
</code></p>

<p>With the command above, you create a runner that uses <a href="https://registry.hub.docker.com/u/library/python/">python:3.2</a> image and uses <a href="https://registry.hub.docker.com/u/library/postgres/">postgres</a> database.</p>

<p>To access PostgreSQL database you need to connect to <code class="prettyprint">host: postgres</code> as user <code class="prettyprint">postgres</code> without password.</p>
