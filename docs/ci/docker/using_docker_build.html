<h1 id="using-docker-build">Using Docker Build</h1>

<p>GitLab CI allows you to use Docker Engine to build and test docker-based projects.</p>

<p><strong>This also allows to you to use <code class="prettyprint">docker-compose</code> and other docker-enabled tools.</strong></p>

<p>This is one of new trends in Continuous Integration/Deployment to:</p>

<ol>
<li>create application image,</li>
<li>run test against created image,</li>
<li>push image to remote registry, </li>
<li>deploy server from pushed image</li>
</ol>

<p>It&rsquo;s also useful in case when your application already has the <code class="prettyprint">Dockerfile</code> that can be used to create and test image:
<code class="prettyprint">bash
$ docker build -t my-image dockerfiles/
$ docker run my-docker-image /script/to/run/tests
$ docker tag my-image my-registry:5000/my-image
$ docker push my-registry:5000/my-image
</code></p>

<p>However, this requires special configuration of GitLab Runner to enable <code class="prettyprint">docker</code> support during build.
<strong>This requires running GitLab Runner in privileged mode which can be harmful when untrusted code is run.</strong></p>

<p>There are two methods to enable the use of <code class="prettyprint">docker build</code> and <code class="prettyprint">docker run</code> during build.</p>

<h2 id="1-use-shell-executor">1. Use shell executor</h2>

<p>The simplest approach is to install GitLab Runner in <code class="prettyprint">shell</code> execution mode.
GitLab Runner then executes build scripts as <code class="prettyprint">gitlab-runner</code> user.</p>

<ol>
<li><p>Install <a href="https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/#installation">GitLab Runner</a>.</p></li>
<li><p>During GitLab Runner installation select <code class="prettyprint">shell</code> as method of executing build scripts or use command:</p>
<pre class="highlight shell"><code><span class="gp">$ </span>sudo gitlab-runner register -n <span class="se">\</span>
  --url http://gitlab.com/ci <span class="se">\</span>
  --token RUNNER_TOKEN <span class="se">\</span>
  --executor shell
  --description <span class="s2">"My Runner"</span>
</code></pre></li>
<li><p>Install Docker on server.</p>

<p>For more information how to install Docker on different systems checkout the <a href="https://docs.docker.com/installation/">Supported installations</a>.</p></li>
<li><p>Add <code class="prettyprint">gitlab-runner</code> user to <code class="prettyprint">docker</code> group:</p>
<pre class="highlight shell"><code><span class="gp">$ </span>sudo usermod -aG docker gitlab-runner
</code></pre></li>
<li><p>Verify that <code class="prettyprint">gitlab-runner</code> has access to Docker:</p>
<pre class="highlight shell"><code><span class="gp">$ </span>sudo -u gitlab-runner -H docker info
</code></pre>

<p>You can now verify that everything works by adding <code class="prettyprint">docker info</code> to <code class="prettyprint">.gitlab-ci.yml</code>:
&ldquo;`yaml
before_script:
  - docker info</p>

<p>build_image:
  script:
    - docker build -t my-docker-image .
    - docker run my-docker-image /script/to/run/tests
&rdquo;`</p></li>
<li><p>You can now use <code class="prettyprint">docker</code> command and install <code class="prettyprint">docker-compose</code> if needed.</p></li>
<li><p>However, by adding <code class="prettyprint">gitlab-runner</code> to <code class="prettyprint">docker</code> group you are effectively granting <code class="prettyprint">gitlab-runner</code> full root permissions.
For more information please checkout <a href="https://www.andreas-jung.com/contents/on-docker-security-docker-group-considered-harmful">On Docker security: <code class="prettyprint">docker</code> group considered harmful</a>.</p></li>
</ol>

<h2 id="2-use-docker-in-docker-executor">2. Use docker-in-docker executor</h2>

<p>Second approach is to use special Docker image with all tools installed (<code class="prettyprint">docker</code> and <code class="prettyprint">docker-compose</code>) and run build script in context of that image in privileged mode.
In order to do that follow the steps:</p>

<ol>
<li><p>Install <a href="https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/#installation">GitLab Runner</a>.</p></li>
<li><p>Register GitLab Runner from command line to use <code class="prettyprint">docker</code> and <code class="prettyprint">privileged</code> mode:</p>
<pre class="highlight shell"><code><span class="gp">$ </span>sudo gitlab-runner register -n <span class="se">\</span>
  --url http://gitlab.com/ci <span class="se">\</span>
  --token RUNNER_TOKEN <span class="se">\</span>
  --executor docker <span class="se">\</span>
  --description <span class="s2">"My Docker Runner"</span> <span class="se">\</span>
  --docker-image <span class="s2">"gitlab/dind:latest"</span> <span class="se">\</span>
  --docker-privileged
</code></pre>

<p>The above command will register new Runner to use special <a href="https://registry.hub.docker.com/u/gitlab/dind/">gitlab/dind</a> image which is provided by GitLab Inc.
The image at the start runs Docker daemon in <a href="https://blog.docker.com/2013/09/docker-can-now-run-within-docker/">docker-in-docker</a> mode.</p></li>
<li><p>You can now use <code class="prettyprint">docker</code> from build script:</p>
<pre class="highlight yaml"><code><span class="s">before_script</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">docker info</span>

<span class="s">build_image</span><span class="pi">:</span>
  <span class="s">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">docker build -t my-docker-image .</span>
    <span class="pi">-</span> <span class="s">docker run my-docker-image /script/to/run/tests</span>
</code></pre></li>
<li><p>However, by enabling <code class="prettyprint">--docker-privileged</code> you are effectively disables all security mechanisms of containers and exposing your host to privilege escalation which can lead to container breakout.
For more information, check out <a href="https://docs.docker.com/reference/run/#runtime-privilege-linux-capabilities-and-lxc-configuration">Runtime privilege</a>.</p></li>
</ol>
