<h1 id="configuration-of-your-builds-with-gitlab-ci-yml">Configuration of your builds with .gitlab-ci.yml</h1>

<p>From version 7.12, GitLab CI uses a <a href="https://en.wikipedia.org/wiki/YAML">YAML</a> file (<strong>.gitlab-ci.yml</strong>) for the project configuration.
It is placed in the root of your repository and contains definitions of how your project should be built.</p>

<p>The YAML file defines a set of jobs with constraints stating when they should be run.
The jobs are defined as top-level elements with a name and always have to contain the <code class="prettyprint">script</code> clause:</p>
<pre class="highlight yaml"><code><span class="s">job1</span><span class="pi">:</span>
  <span class="s">script</span><span class="pi">:</span> <span class="s2">"</span><span class="s">execute-script-for-job1"</span>

<span class="s">job2</span><span class="pi">:</span>
  <span class="s">script</span><span class="pi">:</span> <span class="s2">"</span><span class="s">execute-script-for-job2"</span>
</code></pre>

<p>The above example is the simplest possible CI configuration with two separate jobs,
where each of the jobs executes a different command.
Of course a command can execute code directly (<code class="prettyprint">./configure;make;make install</code>) or run a script (<code class="prettyprint">test.sh</code>) in the repository.</p>

<p>Jobs are used to create builds, which are then picked up by <a href="../runners/README.md">runners</a> and executed within the environment of the runner.
What is important, is that each job is run independently from each other.</p>

<h2 id="gitlab-ci-yml">.gitlab-ci.yml</h2>

<p>The YAML syntax allows for using more complex job specifications than in the above example:</p>
<pre class="highlight yaml"><code><span class="s">image</span><span class="pi">:</span> <span class="s">ruby:2.1</span>
<span class="s">services</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">postgres</span>

<span class="s">before_script</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">bundle_install</span>

<span class="s">stages</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">build</span>
  <span class="pi">-</span> <span class="s">test</span>
  <span class="pi">-</span> <span class="s">deploy</span>

<span class="s">job1</span><span class="pi">:</span>
  <span class="s">stage</span><span class="pi">:</span> <span class="s">build</span>
  <span class="s">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">execute-script-for-job1</span>
  <span class="s">only</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">master</span>
  <span class="s">tags</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">docker</span>
</code></pre>

<p>There are a few <code class="prettyprint">keywords</code> that can&rsquo;t be used as job names:</p>

<table><thead>
<tr>
<th>keyword</th>
<th>required</th>
<th>description</th>
</tr>
</thead><tbody>
<tr>
<td>image</td>
<td>optional</td>
<td>Use docker image, covered in <a href="../docker/README.md">Use Docker</a></td>
</tr>
<tr>
<td>services</td>
<td>optional</td>
<td>Use docker services, covered in <a href="../docker/README.md">Use Docker</a></td>
</tr>
<tr>
<td>stages</td>
<td>optional</td>
<td>Define build stages</td>
</tr>
<tr>
<td>types</td>
<td>optional</td>
<td>Alias for <code class="prettyprint">stages</code></td>
</tr>
<tr>
<td>before_script</td>
<td>optional</td>
<td>Define commands prepended for each job&rsquo;s script</td>
</tr>
<tr>
<td>variables</td>
<td>optional</td>
<td>Define build variables</td>
</tr>
</tbody></table>

<h3 id="image-and-services">image and services</h3>

<p>This allows to specify a custom Docker image and a list of services that can be used for time of the build.
The configuration of this feature is covered in separate document: <a href="../docker/README.md">Use Docker</a>.</p>

<h3 id="before_script">before_script</h3>

<p><code class="prettyprint">before_script</code> is used to define the command that should be run before all builds, including deploy builds. This can be an array or a multiline string.</p>

<h3 id="stages">stages</h3>

<p><code class="prettyprint">stages</code> is used to define build stages that can be used by jobs.
The specification of <code class="prettyprint">stages</code> allows for having flexible multi stage pipelines.</p>

<p>The ordering of elements in <code class="prettyprint">stages</code> defines the ordering of builds&rsquo; execution:</p>

<ol>
<li>Builds of the same stage are run in parallel.</li>
<li>Builds of next stage are run after success.</li>
</ol>

<p>Let&rsquo;s consider the following example, which defines 3 stages:
<code class="prettyprint">
stages:
  - build
  - test
  - deploy
</code></p>

<ol>
<li>First all jobs of <code class="prettyprint">build</code> are executed in parallel.</li>
<li>If all jobs of <code class="prettyprint">build</code> succeeds, the <code class="prettyprint">test</code> jobs are executed in parallel.</li>
<li>If all jobs of <code class="prettyprint">test</code> succeeds, the <code class="prettyprint">deploy</code> jobs are executed in parallel.</li>
<li>If all jobs of <code class="prettyprint">deploy</code> succeeds, the commit is marked as <code class="prettyprint">success</code>.</li>
<li>If any of the previous jobs fails, the commit is marked as <code class="prettyprint">failed</code> and no jobs of further stage are executed.</li>
</ol>

<p>There are also two edge cases worth mentioning:</p>

<ol>
<li>If no <code class="prettyprint">stages</code> is defined in <code class="prettyprint">.gitlab-ci.yml</code>, then by default the <code class="prettyprint">build</code>, <code class="prettyprint">test</code> and <code class="prettyprint">deploy</code> are allowed to be used as job&rsquo;s stage by default.</li>
<li>If a job doesn&rsquo;t specify <code class="prettyprint">stage</code>, the job is assigned the <code class="prettyprint">test</code> stage.</li>
</ol>

<h3 id="types">types</h3>

<p>Alias for <a href="#stages">stages</a>.</p>

<h3 id="variables">variables</h3>

<p><strong>This feature requires <code class="prettyprint">gitlab-runner</code> with version equal or greater than 0.5.0.</strong></p>

<p>GitLab CI allows you to add to <code class="prettyprint">.gitlab-ci.yml</code> variables that are set in build environment.
The variables are stored in repository and are meant to store non-sensitive project configuration, ie. RAILS_ENV or DATABASE_URL.</p>
<pre class="highlight yaml"><code><span class="s">variables</span><span class="pi">:</span>
  <span class="s">DATABASE_URL</span><span class="pi">:</span> <span class="s2">"</span><span class="s">postgres://postgres@postgres/my_database"</span>
</code></pre>

<p>These variables can be later used in all executed commands and scripts.</p>

<p>The YAML-defined variables are also set to all created service containers, thus allowing to fine tune them.</p>

<h2 id="jobs">Jobs</h2>

<p><code class="prettyprint">.gitlab-ci.yml</code> allows you to specify an unlimited number of jobs.
Each job has to have a unique <code class="prettyprint">job_name</code>, which is not one of the keywords mentioned above.
A job is defined by a list of parameters that define the build behaviour.</p>
<pre class="highlight yaml"><code><span class="s">job_name</span><span class="pi">:</span>
  <span class="s">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">rake spec</span>
    <span class="pi">-</span> <span class="s">coverage</span>
  <span class="s">stage</span><span class="pi">:</span> <span class="s">test</span>
  <span class="s">only</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">master</span>
  <span class="s">except</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">develop</span>
  <span class="s">tags</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">ruby</span>
    <span class="pi">-</span> <span class="s">postgres</span>
  <span class="s">allow_failure</span><span class="pi">:</span> <span class="s">true</span>
</code></pre>

<table><thead>
<tr>
<th>keyword</th>
<th>required</th>
<th>description</th>
</tr>
</thead><tbody>
<tr>
<td>script</td>
<td>required</td>
<td>Defines a shell script which is executed by runner</td>
</tr>
<tr>
<td>stage</td>
<td>optional (default: test)</td>
<td>Defines a build stage</td>
</tr>
<tr>
<td>type</td>
<td>optional</td>
<td>Alias for <code class="prettyprint">stage</code></td>
</tr>
<tr>
<td>only</td>
<td>optional</td>
<td>Defines a list of git refs for which build is created</td>
</tr>
<tr>
<td>except</td>
<td>optional</td>
<td>Defines a list of git refs for which build is not created</td>
</tr>
<tr>
<td>tags</td>
<td>optional</td>
<td>Defines a list of tags which are used to select runner</td>
</tr>
<tr>
<td>allow_failure</td>
<td>optional</td>
<td>Allow build to fail. Failed build doesn&rsquo;t contribute to commit status</td>
</tr>
</tbody></table>

<h3 id="script">script</h3>

<p><code class="prettyprint">script</code> is a shell script which is executed by runner. The shell script is prepended with <code class="prettyprint">before_script</code>.</p>
<pre class="highlight yaml"><code><span class="s">job</span><span class="pi">:</span>
  <span class="s">script</span><span class="pi">:</span> <span class="s2">"</span><span class="s">bundle</span><span class="nv"> </span><span class="s">exec</span><span class="nv"> </span><span class="s">rspec"</span>
</code></pre>

<p>This parameter can also contain several commands using an array:
<code class="prettyprint">yaml
job:
  script:
    - uname -a
    - bundle exec rspec
</code></p>

<h3 id="stage">stage</h3>

<p><code class="prettyprint">stage</code> allows to group build into different stages. Builds of the same <code class="prettyprint">stage</code> are executed in <code class="prettyprint">parallel</code>.
For more info about the use of <code class="prettyprint">stage</code> please check the <a href="#stages">stages</a>.</p>

<h3 id="only-and-except">only and except</h3>

<p>This are two parameters that allow for setting a refs policy to limit when jobs are built:
1. <code class="prettyprint">only</code> defines the names of branches and tags for which job will be built.
2. <code class="prettyprint">except</code> defines the names of branches and tags for which the job wil <strong>not</strong> be built.</p>

<p>There are a few rules that apply to usage of refs policy:</p>

<ol>
<li><code class="prettyprint">only</code> and <code class="prettyprint">except</code> are exclusive. If both <code class="prettyprint">only</code> and <code class="prettyprint">except</code> are defined in job specification only <code class="prettyprint">only</code> is taken into account.</li>
<li><code class="prettyprint">only</code> and <code class="prettyprint">except</code> allow for using the regexp expressions.</li>
<li><code class="prettyprint">only</code> and <code class="prettyprint">except</code> allow for using special keywords: <code class="prettyprint">branches</code> and <code class="prettyprint">tags</code>.
These names can be used for example to exclude all tags and all branches.</li>
</ol>
<pre class="highlight yaml"><code><span class="s">job</span><span class="pi">:</span>
  <span class="s">only</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">/^issue-.*$/</span> <span class="c1"># use regexp</span>
  <span class="s">except</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">branches</span> <span class="c1"># use special keyword</span>
</code></pre>

<h3 id="tags">tags</h3>

<p><code class="prettyprint">tags</code> is used to select specific runners from the list of all runners that are allowed to run this project.</p>

<p>During registration of a runner, you can specify the runner&rsquo;s tags, ie.: <code class="prettyprint">ruby</code>, <code class="prettyprint">postgres</code>, <code class="prettyprint">development</code>.
<code class="prettyprint">tags</code> allow you to run builds with runners that have the specified tags assigned:</p>
<pre class="highlight plaintext"><code>job:
  tags:
    - ruby
    - postgres
</code></pre>

<p>The above specification will make sure that <code class="prettyprint">job</code> is built by a runner that have <code class="prettyprint">ruby</code> AND <code class="prettyprint">postgres</code> tags defined.</p>

<h2 id="validate-the-gitlab-ci-yml">Validate the .gitlab-ci.yml</h2>

<p>Each instance of GitLab CI has an embedded debug tool called Lint.
You can find the link to the Lint in the project&rsquo;s settings page or use short url <code class="prettyprint">/lint</code>.</p>

<h2 id="skipping-builds">Skipping builds</h2>

<p>There is one more way to skip all builds, if your commit message contains tag [ci skip]. In this case, commit will be created but builds will be skipped</p>
